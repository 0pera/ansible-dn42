# Generated by Ansible
{% macro ibgp_cost(nodedata) -%}
# Costs are specified in ibgp_costs.yml and default to 200 if not given.
# Only one of (A,B) and (B,A) have to be defined, to save space.
{% set default_cost = 200 %}
{{ (ibgp_costs.get('%s,%s' % (shortname, nodedata['shortname'])) or
    ibgp_costs.get('%s,%s' % (nodedata['shortname'], shortname)) or default_cost) }}
{%- endmacro %}

{% for host in ansible_play_hosts_all %}
{% if host != inventory_hostname %}
{% set nodedata = hostvars[host] %}

protocol bgp ibgp_{{ nodedata['shortname'] | replace("-", "_") }} {
    local as {{ ownas }};
    neighbor {{ nodedata['ownip6'] }} as {{ ownas }};
    direct;

    ipv4 {
        next hop self;
        cost {{ ibgp_cost(nodedata) }};
        # Treat the preconfigured iBGP cost as a fake igp_metric - this way we can expose it
        # as a MED attribute to external peers.
        # From bird manual:
        # "int igp_metric [is an] optional attribute that can be used to specify a distance to the
        # network for routes that do not have a native protocol metric attribute (like ospf_metric1
        # for OSPF routes)."
        import filter {
            igp_metric = {{ ibgp_cost(nodedata) }};
            accept;
        };
        export all;
    };

    ipv6 {
        next hop self;
        cost {{ ibgp_cost(nodedata) }};
        import filter {
            igp_metric = {{ ibgp_cost(nodedata) }};
            accept;
        };
        export all;
    };
}
{% endif %}
{% endfor %}
