# Generated by Ansible
{% macro ibgp_link(nodedata, rr_client=False) -%}
protocol bgp ibgp_{{ nodedata['shortname'] | replace("-", "_") }} {
    local as {{ ownas }};
    neighbor {{ nodedata['ownip6'] }} as {{ ownas }};
    source address {{ ownip6 }};
{% if rr_client %}
    rr client;
{% endif %}
    advertise hostname on;

    ipv4 {
        import where ibgp_import_filter();
        export where ibgp_export_filter();
        next hop address {{ ownip }};
        next hop self;
    };

    ipv6 {
        import where ibgp_import_filter();
        export where ibgp_export_filter();
        next hop address {{ ownip6 }};
        next hop self;
    };
}
{%- endmacro %}

{# Template RR upstreams for servers not in mesh #}
{% if ibgp_rr_upstreams is defined %}
{% for host in ibgp_rr_upstreams %}
{{ ibgp_link(hostvars[host], rr_client=True) }}
{% endfor %}
{% else %}
{# Template mesh links and RR clients #}
{% for host in groups['dn42routers'] %}
{% set nodedata = hostvars[host] %}
{% if host != inventory_hostname and ('ibgp_rr_upstreams' not in nodedata or inventory_hostname in nodedata['ibgp_rr_upstreams']) %}
{{ ibgp_link(nodedata, rr_client='ibgp_rr_upstreams' in nodedata) }}
{% endif %}
{% endfor %}
{% endif %}
