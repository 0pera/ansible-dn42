- name: Configure anycast services
  hosts: anycast_pool
  become: yes
  pre_tasks:
    - name: Update cached copy of dn42 registry
      local_action: shell cd dn42-registry && git pull
      become: false
      run_once: true
    - name: Generate DNS zones
      local_action: command scripts/make-dns-records.py
      become: false
      run_once: true

  roles:
    # Configure loopback for auth DNS anycast
    - role: config-loopback
      ownip: "{{ anycast_ip }}"
      ownip6: "{{ anycast_ip6 }}"
      dummy_ifname: "{{ dummy_ifname_anycast }}"
      dummy_iface_conf_name: "dn42-dummy-anycast"

    # Configure loopback for recursive DNS anycast
    - role: config-loopback
      ownip: "{{ anycast_recursors_ip }}"
      ownip6: "{{ anycast_recursors_ip6 }}"
      dummy_ifname: "{{ dummy_ifname_anycast_recursors }}"
      dummy_iface_conf_name: "dn42-dummy-anycast-recursors"

    # Install & configure PowerDNS authoritative server
    - role: PowerDNS.pdns
      # PowerDNS 4.3.x
      pdns_install_repo: "{{ pdns_auth_powerdns_repo_43 if ansible_distribution_release == 'buster' else '' }}"
      pdns_config:
        local-address: "{{ anycast_ip }},{{ anycast_ip6 | ipwrap }}"
      pdns_backends:
        bind:
          config: "{{ pdns_config_dir }}/named.conf"

    # Configure zone files for authoritative DNS
    - role: config-powerdns-zones

    # Upload config files for pdns-recursor
    - role: config-powerdns-recursor

    # Install & configure PowerDNS resolver
    - role: PowerDNS.pdns_recursor
      pdns_rec_install_repo: "{{ pdns_rec_powerdns_repo_43 if ansible_distribution_release == 'buster' else '' }}"
      pdns_rec_config:
        # Reduce dont-query list from defaults to exclude dn42 ranges
        dont-query: 127.0.0.0/8, 10.0.0.0/8, 192.168.0.0/16, ::1/128, fe80::/10

        forward-zones-file: "{{ pdns_rec_config_dir }}/recursive-zones.conf"
        lua-config-file: "{{ pdns_rec_config_dir }}/recursor.lua"

        # DNSSEC
        dnssec: validate
        dnssec-log-bogus: true
        # Don't cache records where DNSSEC validation failed. (I seem to get intermittent validation issues?)
        max-cache-bogus-ttl: 20

        # Allow sending queries over IPv6
        query-local-address6: "::"

        local-address: "127.0.0.1,::1,{{ anycast_recursors_ip }},{{ anycast_recursors_ip6 | ipwrap }}"

      # Work around errors described at https://github.com/PowerDNS/pdns_recursor-ansible/issues/69
      pdns_rec_service_overrides:
        User: "{{ pdns_rec_user }}"
        Group: "{{ pdns_rec_group }}"
